# Validation and Testing Makefile
# Comprehensive validation targets based on lessons learned from fixing critical issues

PYTHON ?= python3
VENV ?= venv_hardening

# Colors for output
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
NC := \033[0m # No Color

.PHONY: help validate-all ports dockerfiles env-vars health-checks health-endpoints health-continuous health-discover config-drift validate-config-drift validate-config-drift-auto validate-config-scan validate-api-contracts validate-api-compare dependencies startup integration ci-ready monitoring

help: ## Show validation commands
	@echo "$(BLUE)ðŸ” Ecosystem Validation Commands$(NC)"
	@echo "================================"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "$(BLUE)%-25s$(NC) %s\n", $$1, $$2}'

# ========================================
# COMPREHENSIVE VALIDATION
# ========================================

validate-all: ports dockerfiles env-vars health-checks health-endpoints validate-config-drift validate-api-contracts dependencies startup integration comprehensive ## Run all validation checks
	@echo "$(GREEN)âœ… All validation checks completed$(NC)"

# ========================================
# INDIVIDUAL VALIDATION TARGETS
# ========================================

ports: ## Validate port configurations and detect conflicts
	@echo "$(BLUE)ðŸ” Validating port configurations...$(NC)"
	source $(VENV)/bin/activate && python3 scripts/hardening/docker_standardization.py
	@echo "$(GREEN)âœ… Port validation completed$(NC)"

dockerfiles: ## Validate and lint all Dockerfiles
	@echo "$(BLUE)ðŸ” Validating Dockerfiles...$(NC)"
	@for service in services/*/; do \
		if [ -f "$$service/Dockerfile" ]; then \
			service_name=$$(basename $$service); \
			echo "  Validating $$service_name..."; \
			docker build --dry-run $$service > /dev/null 2>&1 || echo "  âŒ $$service_name has Dockerfile issues"; \
		fi \
	done
	@echo "$(GREEN)âœ… Dockerfile validation completed$(NC)"

env-vars: ## Validate environment variable consistency
	@echo "$(BLUE)ðŸ” Validating environment variables...$(NC)"
	source $(VENV)/bin/activate && python3 scripts/safeguards/environment_aware_cli.py --validate-env
	@echo "$(GREEN)âœ… Environment variable validation completed$(NC)"

health-checks: ## Validate health check endpoints
	@echo "$(BLUE)ðŸ” Validating health check endpoints...$(NC)"
	source $(VENV)/bin/activate && python3 scripts/safeguards/unified_health_monitor.py --validate-endpoints
	@echo "$(GREEN)âœ… Health check validation completed$(NC)"

health-endpoints: ## Comprehensive health endpoint validation
	@echo "$(BLUE)ðŸ¥ Running comprehensive health endpoint validation...$(NC)"
	source $(VENV)/bin/activate && python3 scripts/safeguards/health_endpoint_validator.py --verbose --save-report
	@echo "$(GREEN)âœ… Health endpoint validation completed$(NC)"

health-continuous: ## Continuous health monitoring
	@echo "$(BLUE)ðŸ”„ Starting continuous health monitoring (5 minutes)...$(NC)"
	source $(VENV)/bin/activate && python3 scripts/safeguards/health_endpoint_validator.py --mode continuous --duration 5 --verbose
	@echo "$(GREEN)âœ… Continuous health monitoring completed$(NC)"

health-discover: ## Discover health check endpoints
	@echo "$(BLUE)ðŸ” Discovering health check endpoints...$(NC)"
	source $(VENV)/bin/activate && python3 scripts/safeguards/health_endpoint_validator.py --mode discover
	@echo "$(GREEN)âœ… Endpoint discovery completed$(NC)"

config-drift: ## Detect configuration drift between files
	@echo "$(BLUE)ðŸ” Detecting configuration drift...$(NC)"
	source $(VENV)/bin/activate && python3 scripts/hardening/docker_standardization.py --check-drift
	@echo "$(GREEN)âœ… Configuration drift detection completed$(NC)"

validate-config-drift: ## Comprehensive configuration drift detection
	@echo "$(BLUE)ðŸ” Running comprehensive configuration drift detection...$(NC)"
	source $(VENV)/bin/activate && python3 scripts/safeguards/config_drift_detector.py --verbose --save-report
	@echo "$(GREEN)âœ… Configuration drift detection completed$(NC)"

validate-config-drift-auto: ## Configuration drift detection with auto-correction
	@echo "$(BLUE)ðŸ”§ Running configuration drift detection with auto-correction...$(NC)"
	source $(VENV)/bin/activate && python3 scripts/safeguards/config_drift_detector.py --auto-correct --verbose
	@echo "$(GREEN)âœ… Configuration drift auto-correction completed$(NC)"

validate-config-scan: ## Scan configuration files only
	@echo "$(BLUE)ðŸ” Scanning configuration files...$(NC)"
	source $(VENV)/bin/activate && python3 scripts/safeguards/config_drift_detector.py --scan-only
	@echo "$(GREEN)âœ… Configuration scan completed$(NC)"

validate-api-contracts: ## Validate API contracts between services
	@echo "$(BLUE)ðŸ”— Validating API contracts...$(NC)"
	source $(VENV)/bin/activate && python3 scripts/safeguards/api_contract_validator.py --verbose --save-report
	@echo "$(GREEN)âœ… API contract validation completed$(NC)"

validate-api-compare: ## Compare API specifications (usage: make validate-api-compare OLD_SPEC=new.json NEW_SPEC=old.json)
	@echo "$(BLUE)ðŸ” Comparing API specifications...$(NC)"
	source $(VENV)/bin/activate && python3 scripts/safeguards/api_contract_validator.py --compare $(OLD_SPEC) $(NEW_SPEC) --verbose
	@echo "$(GREEN)âœ… API comparison completed$(NC)"

dependencies: ## Validate service dependencies
	@echo "$(BLUE)ðŸ” Validating service dependencies...$(NC)"
	source $(VENV)/bin/activate && python3 scripts/hardening/service_connectivity_validator.py --check-deps
	@echo "$(GREEN)âœ… Dependency validation completed$(NC)"

startup: ## Validate service startup configurations
	@echo "$(BLUE)ðŸ” Validating service startup...$(NC)"
	@echo "  Checking startup scripts..."
	@for service in services/*/; do \
		if [ -f "$$service/main.py" ]; then \
			service_name=$$(basename $$service); \
			echo "  âœ… $$service_name has main.py"; \
		fi \
	done
	@echo "$(GREEN)âœ… Startup validation completed$(NC)"

integration: ## Run integration tests
	@echo "$(BLUE)ðŸ”— Running integration tests...$(NC)"
	python3 ecosystem_functional_test_suite.py
	@echo "$(GREEN)âœ… Integration tests completed$(NC)"

comprehensive: ## Run comprehensive validation across all systems
	@echo "$(BLUE)ðŸ” Running comprehensive validation...$(NC)"
	source $(VENV)/bin/activate && python3 scripts/hardening/docker_standardization.py --check-drift
	@echo "$(GREEN)âœ… Comprehensive validation completed$(NC)"

# ========================================
# CI/CD VALIDATION
# ========================================

ci-ready: validate-all integration ## Validate everything is ready for CI/CD
	@echo "$(GREEN)ðŸš€ Ecosystem is CI/CD ready!$(NC)"

ci-validate: ports dockerfiles env-vars ## Quick CI validation (no integration tests)
	@echo "$(GREEN)âœ… CI validation passed$(NC)"

# ========================================
# MONITORING AND ALERTING
# ========================================

monitoring: ## Run monitoring checks
	@echo "$(BLUE)ðŸ“Š Running monitoring checks...$(NC)"
	source $(VENV)/bin/activate && python3 scripts/safeguards/unified_health_monitor.py
	@echo "$(GREEN)âœ… Monitoring checks completed$(NC)"

alerts: ## Check for critical alerts
	@echo "$(BLUE)ðŸš¨ Checking for critical alerts...$(NC)"
	source $(VENV)/bin/activate && python3 scripts/safeguards/unified_health_monitor.py --check-alerts
	@echo "$(GREEN)âœ… Alert check completed$(NC)"

# ========================================
# DEVELOPMENT HELPERS
# ========================================

setup-validation: ## Set up validation environment
	@echo "$(BLUE)ðŸ”§ Setting up validation environment...$(NC)"
	$(PYTHON) -m venv $(VENV)
	source $(VENV)/bin/activate && pip install -U pip
	source $(VENV)/bin/activate && pip install pydantic PyYAML redis requests
	@echo "$(GREEN)âœ… Validation environment ready$(NC)"

quick-validate: ports env-vars health-endpoints ## Quick validation for development
	@echo "$(GREEN)âœ… Quick validation completed$(NC)"

pre-commit: validate-all ## Pre-commit validation
	@echo "$(GREEN)âœ… Pre-commit validation passed$(NC)"

# ========================================
# REPORTING
# ========================================

report: ## Generate validation report
	@echo "$(BLUE)ðŸ“‹ Generating validation report...$(NC)"
	@echo "Validation Report - $$(date)" > validation_report.txt
	@echo "==================" >> validation_report.txt
	@echo "" >> validation_report.txt
	@make ports >> validation_report.txt 2>&1 || echo "Port validation failed" >> validation_report.txt
	@make dockerfiles >> validation_report.txt 2>&1 || echo "Dockerfile validation failed" >> validation_report.txt
	@echo "$(GREEN)âœ… Report generated: validation_report.txt$(NC)"

# ========================================
# CLEANUP
# ========================================

clean-validation: ## Clean validation artifacts
	@echo "$(YELLOW)ðŸ§¹ Cleaning validation artifacts...$(NC)"
	@rm -f validation_report.txt
	@rm -f ecosystem_audit_results.json
	@docker system prune -f > /dev/null 2>&1 || true
	@echo "$(GREEN)âœ… Cleanup completed$(NC)"

# Default target
.DEFAULT_GOAL := help
